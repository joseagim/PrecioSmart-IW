<!DOCTYPE html>
<html class="h-100" xmlns:th="http://www.thymeleaf.org">

<head>
    <th:block th:replace="~{fragments/head :: header}" />
    <title>PrecioSmart Carritos</title>

</head>

<body class="d-flex flex-column h-100 text-center">
    <header th:replace="~{fragments/nav.html :: nav}"></header>

    <main class="flex-shrink-0">
        <div class="container">
            
            <div class="contenedores-carrito">
                <div class="d-flex justify-content-between align-items-center mt-2 mb-2">
                    <div>
                        <h1 class="text-start">
                            Mis carritos
                            <span id="contadorCarritos">(0)</span>
                        </h1>
                    </div>
                    <div>
                        <button class="btn btn-naranja" onclick="borrarCarrito()">üîÑÔ∏è Borrar carrito</button>
                        <button class="btn btn-naranja" onclick="crearNuevoCarrito()">üÜï Nuevo carrito</button>
                    </div>
                </div>
            
                <p id="mensajeSeleccion" class="text-start">Selecciona un carrito para ver su contenido.</p>

                <div class="d-flex flex-row flex-nowrap overflow-auto gap-3 pb-3" id="contenedorCarritos">
                    <!-- JS METE LOS CARRITOS -->
                </div>
            </div>

            <div class="contenedores-carrito">

                <div id="alertaSeleccion">
                    <p class="text-muted mb-3">Selecciona un carrito para ver los productos.</p>
                    <a th:href="@{/search}" class="btn btn-naranja">üîéBuscar Productos</a>
                </div>

                <div id="tablaProductos" class="d-none">
                    <table class="table-carrito align-middle mt-2 shadow-sm border">
                        <thead class="thead-carrito">
                            <tr>
                                <th>Producto</th>
                                <th>Unidades</th>
                                <th>Precio/u</th>
                                <th>Subtotal</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="filas-tabla" class="tbody-carrito">
                            <!-- Aqu√≠ se inyectar√°n las filas -->
                        </tbody>
                        <tfoot class="tfoot-carrito">
                            <tr>
                                <td colspan="3" class="text-end text-uppercase fw-bold">Total estimado:</td>
                                <td colspan="1"><strong id="precioTotalTabla" class="fs-5 text-success">0.00‚Ç¨</strong></td>
                                <td colspan="1" id="vaciarCarro" class="text-uppercase fw-bold"><button class="btn btn-sm tProd-delete" onclick="vaciarCarrito()">üóëÔ∏èVaciar</button>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                    <a th:href="@{/search}" class="btn btn-naranja">üîéBuscar Productos</a>
                </div>
            
                <!-- Template para las tarjetas de carritos -->
                <template id="tarjeta-carrito-template">
                    <div class="card card-carrito">
                        <div class="card-body text-start">
                            <h5 class="card-title fw-bold d-flex justify-content-between justify-content-center align-items-center">
                                <span class="nombre-carrito-txt">Carrito</span>
                                <button class="btn btn-sm btn-edit">‚úèÔ∏è</button>
                            </h5>
                            <p class="card-text cant-productos-txt">0 Productos</p>
                            <p class="card-text fecha-carrito-txt">01/01/2026</p>
                        </div>
                    </div>
                </template>

                <!-- Template para las filas de productos -->
                <template id="fila-producto-template">
                    <tr>
                        <td class="tProd-nombre fw-bold text-start"></td>
                        <td class="tProd-cantidad"><div class="d-flex justify-content-center align-items-center">
                            <button class="btn btn-control-cantidad btn-restar text-start">-  </button><span class="tProd-cantidad-num">1</span><button class="btn btn-control-cantidad btn-sumar text-end">  +</button>
                        </div></td>
                        <td class="tProd-precio"></td>
                        <td class="tProd-subtotal fw-bold"></td>
                        <td>
                            <button class="tProd-delete btn btn-sm">
                                üóëÔ∏è
                            </button>
                        </td>
                    </tr>
                </template>
            </div>

        <th:block th:replace="~{fragments/footer.html :: footer}" />

    </main>

    <script th:inline="javascript">
        
        const listaCarritos = [
            {
                name: "Primero",
                createdAt: "19/02/2026",
                products: [
                    { name: "Leche", price: 1.50, quantity: 1 },
                    { name: "Pan", price: 0.80, quantity: 1 },
                    { name: "Huevos", price: 2.00, quantity: 1 },
                    { name: "Manzanas", price: 1.20, quantity: 1 },
                    { name: "Arroz", price: 1.00, quantity: 1 }
                ]
            },
            {
                name: "Carrito 2",
                createdAt: "17/02/2026",
                products: []
            },
            {
                name: "Carrito 3",
                createdAt: "19/02/2026",
                products: []
            }
        ];
        
        // Referencias al DOM
        const contenedorCarritos = document.getElementById('contenedorCarritos');
        const contadorCarritos = document.getElementById('contadorCarritos');
        const alertaSeleccion = document.getElementById('alertaSeleccion');

        const tablaProductos = document.getElementById('tablaProductos');
        const filasTabla = document.getElementById('filas-tabla');
        const precioTotal = document.getElementById('precioTotalTabla');
        
        function inicializar() {
            contadorCarritos.textContent = `(${listaCarritos.length})`;
            contenedorCarritos.innerHTML = "";
            
            listaCarritos.forEach(carrito => {
                const clon = document.getElementById('tarjeta-carrito-template').content.cloneNode(true);

                const card = clon.querySelector('.card-carrito');
                clon.querySelector('.nombre-carrito-txt').textContent = carrito.name;
                clon.querySelector('.cant-productos-txt').textContent = `${carrito.products.length} Producto(s)`;
                clon.querySelector('.fecha-carrito-txt').textContent = `Creado: ${carrito.createdAt}`;
                card.onclick = () => seleccionarCarrito(card, carrito.name);

                clon.querySelector('.btn-edit').onclick = (e) => {
                    e.stopPropagation(); // Evitar que se dispare el onclick de la tarjeta
                    editarNombreCarrito(carrito.name);
                };

                contenedorCarritos.appendChild(clon);
            });
        }

        function seleccionarCarrito(elemento, nombreCarrito) {
            // 1. Gestionar estilos de tarjetas (Quitar activa de otros, poner en el actual)
            document.querySelectorAll('.card-carrito').forEach(card => card.classList.remove('card-activa'));
            elemento.classList.add('card-activa');
            document.getElementById('mensajeSeleccion').classList.add('d-none');

            // 2. Buscar datos del carrito
            const miCarrito = listaCarritos.find(carrito => carrito.name === nombreCarrito);

            if (miCarrito && miCarrito.products && miCarrito.products.length > 0) {
                actualizarInterfaz(miCarrito, miCarrito.products);
            } else {
                mostrarVacio();
            }
        }

        function actualizarInterfaz(carrito, productos) {
            // Limpiar tabla
            filasTabla.innerHTML = "";
            let sumaTotal = 0;

            // Llenar tabla usando el Template
            productos.forEach(prod => {
                const clon = document.getElementById('fila-producto-template').content.cloneNode(true);
                const subtotal = (prod.price * prod.quantity);
                sumaTotal += subtotal;

                clon.querySelector('.tProd-nombre').textContent = prod.name;
                clon.querySelector('.tProd-cantidad-num').textContent = prod.quantity;
                clon.querySelector('.tProd-precio').textContent = prod.price.toFixed(2) + "‚Ç¨";
                clon.querySelector('.tProd-subtotal').textContent = subtotal.toFixed(2) + "‚Ç¨";

                clon.querySelector('.btn-sumar').onclick = () => modificarCantidad(prod.name, 1);
                clon.querySelector('.btn-restar').onclick = () => modificarCantidad(prod.name, -1);
                clon.querySelector('.tProd-delete').onclick = () => eliminarProducto(prod.name);

                filasTabla.appendChild(clon);
            });

            // Actualizar total y visibilidad
            precioTotal.textContent = sumaTotal.toFixed(2) + "‚Ç¨";
            
            tablaProductos.classList.remove('d-none');
            alertaSeleccion.classList.add('d-none');
        }

        function mostrarVacio() {
            tablaProductos.classList.add('d-none');
            alertaSeleccion.classList.remove('d-none');
            alertaSeleccion.querySelector('p').textContent = "Este carrito est√° vac√≠o actualmente.";
        }

        function modificarCantidad(nombreProducto, cantidad) {
            const carritoActivo = document.querySelector('.card-activa .nombre-carrito-txt').textContent;
            const carrito = listaCarritos.find(c => c.name === carritoActivo);
            if (carrito !== undefined) {
                const producto = carrito.products.find(p => p.name === nombreProducto);
                if (producto !== undefined) {
                    producto.quantity += cantidad;
                    if (producto.quantity <= 0) {
                        eliminarProducto(nombreProducto);
                    } else {
                        actualizarInterfaz(carrito, carrito.products);
                    }
                }
            }
        }

        function crearNuevoCarrito() {

            let nombre = window.prompt("Introduce el nombre del nuevo carrito:");

            if (nombre !== "" && nombre !== null) {

                nombre = nombre.trim();

                if (listaCarritos.some(c => c.name.toLowerCase() === nombre.toLowerCase())) {
                    window.alert("Ya tienes un carrito con ese nombre. Por favor, elige uno distinto.");
                    return;
                }

                const nuevoCarrito = {
                    name: nombre,
                    createdAt: new Date().toLocaleDateString('es-ES'),
                    products: []
                };

                listaCarritos.push(nuevoCarrito);
                inicializar();
            }
        }

        function borrarCarrito() {
            const carritoActivo = document.querySelector('.card-activa .nombre-carrito-txt').textContent;
            const indice = listaCarritos.findIndex(c => c.name === carritoActivo);
            if (indice !== -1) {
                listaCarritos.splice(indice, 1);
                mostrarVacio();
                inicializar();
            }
        }

        function eliminarProducto(nombreProducto) {
            const carritoActivo = document.querySelector('.card-activa .nombre-carrito-txt').textContent;
            const carrito = listaCarritos.find(c => c.name === carritoActivo);
            if (carrito !== undefined) {
                const indice = carrito.products.findIndex(p => p.name === nombreProducto);
                if (indice !== -1) {
                    carrito.products.splice(indice, 1);
                }
                if (carrito.products.length > 0) {
                    actualizarInterfaz(carrito, carrito.products);
                } else {
                    mostrarVacio();
                }
            }
        }

        function vaciarCarrito() {
            const carritoActivo = document.querySelector('.card-activa .nombre-carrito-txt').textContent;
            const carrito = listaCarritos.find(c => c.name === carritoActivo);
            if (carrito !== undefined) {
                carrito.products = [];
                mostrarVacio();
                inicializar();
            }
        }

        function editarNombreCarrito(nombreAnterior) {

            let nuevoNombre = window.prompt("Introduce el nuevo nombre del carrito:", nombreAnterior);

            if (nuevoNombre !== null) {
                nuevoNombre = nuevoNombre.trim();

                if (nuevoNombre === "") {
                    alert("El nombre no puede estar vac√≠o.");
                    return;
                }

                if (listaCarritos.some(c => c.name.toLowerCase() === nuevoNombre.toLowerCase() && c.name !== nombreAnterior)) {
                    alert("Ya tienes un carrito con ese nombre.");
                    return;
                }

                let carrito = listaCarritos.findIndex(c => c.name === nombreAnterior);
                if (carrito !== -1) {
                    listaCarritos[carrito].name = nuevoNombre;
                    inicializar();
                }
            }
        }

        window.onload = inicializar;
    </script>

    
</body>

</html>